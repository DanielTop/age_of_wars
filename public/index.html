<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age of Wars</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #fff;
            overflow-x: hidden;
        }

        h1 {
            margin-bottom: 10px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #gameContainer {
            position: relative;
            border: 3px solid #ffd700;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        #gameCanvas { display: block; }

        .ui-panel {
            width: 1000px;
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .ui-panel.p2 {
            border: 2px solid #f5576c;
        }

        #topBar, .topBar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 8px;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: bold;
        }

        .resource span { color: #ffd700; }
        .resource.p2 span { color: #f5576c; }

        .eraDisplay {
            text-align: center;
            padding: 5px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
        }

        .eraDisplay.p2 {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }

        #waveInfo {
            text-align: center;
            padding: 5px 15px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
        }

        #healthBars {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .health-container { width: 45%; }

        .health-label {
            font-size: 12px;
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
        }

        .health-bar {
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            transition: width 0.3s;
            border-radius: 10px;
        }

        .player-health { background: linear-gradient(90deg, #00b09b, #96c93d); }
        .enemy-health { background: linear-gradient(90deg, #cb2d3e, #ef473a); }

        .xp-bar { margin-bottom: 8px; }

        .xp-container {
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .xp-fill.p2 {
            background: linear-gradient(90deg, #f5576c, #f093fb);
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s;
            color: #fff;
            min-width: 90px;
            user-select: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.affordable {
            box-shadow: 0 0 10px rgba(56, 239, 125, 0.5);
        }

        .unit-btn { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .upgrade-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .evolve-btn { background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%); color: #000; }
        .special-btn { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); }

        .separator {
            width: 2px;
            background: #444;
            margin: 0 5px;
            align-self: stretch;
        }

        .hotkey {
            display: inline-block;
            background: rgba(0,0,0,0.3);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 3px;
        }

        .level {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: #FFD700;
            margin: 0 2px;
        }

        #statsBar {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        #statsBar span { color: #ffd700; }

        /* –ú–µ–Ω—é */
        #menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        #menu h1 {
            font-size: 64px;
            color: #ffd700;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.5), 0 0 40px rgba(255,215,0,0.3);
            margin-bottom: 10px;
        }

        #menu .subtitle {
            font-size: 18px;
            color: #888;
            margin-bottom: 30px;
        }

        #status {
            font-size: 16px;
            color: #f5576c;
            margin-bottom: 20px;
            min-height: 24px;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .menu-btn {
            padding: 18px 50px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 280px;
            color: #fff;
        }

        .menu-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        .menu-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .menu-btn.ai { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .menu-btn.online { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .menu-btn.local { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

        .controls-info {
            margin-top: 30px;
            text-align: center;
            color: #666;
            font-size: 13px;
        }

        .controls-info h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .controls-grid {
            display: flex;
            gap: 30px;
            justify-content: center;
        }

        .player-controls {
            background: rgba(0,0,0,0.3);
            padding: 12px 20px;
            border-radius: 10px;
        }

        .player-controls h4 {
            color: #38ef7d;
            margin-bottom: 6px;
        }

        .player-controls.p2 h4 {
            color: #f5576c;
        }

        /* Game Over */
        #gameOver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
        }

        #gameOver h2 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        #gameOver.victory h2 { color: #38ef7d; }
        #gameOver.defeat h2 { color: #ef473a; }

        #gameOver .stats {
            font-size: 18px;
            color: #aaa;
            margin-bottom: 20px;
        }

        #restartBtn {
            padding: 15px 40px;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- –ú–ï–ù–Æ -->
    <div id="menu">
        <h1>Age of Wars</h1>
        <div class="subtitle">v2.0 - –í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –∏–≥—Ä—ã</div>
        <div id="status"></div>

        <div class="menu-buttons">
            <button class="menu-btn ai" onclick="startGame('ai')">ü§ñ –ü—Ä–æ—Ç–∏–≤ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</button>
            <button class="menu-btn online" id="onlineBtn" onclick="startOnline()">üåê –û–Ω–ª–∞–π–Ω (2 –∏–≥—Ä–æ–∫–∞)</button>
            <button class="menu-btn local" onclick="startGame('local')">üéÆ –õ–æ–∫–∞–ª—å–Ω–æ (2 –∏–≥—Ä–æ–∫–∞)</button>
        </div>

        <div class="controls-info">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="controls-grid">
                <div class="player-controls">
                    <h4>–ò–≥—Ä–æ–∫ 1</h4>
                    <div>1, 2, 3 - –Æ–Ω–∏—Ç—ã</div>
                    <div>Q, W, R - –ê–ø–≥—Ä–µ–π–¥—ã –±–∞–∑—ã</div>
                    <div>A, S, D - –ê–ø–≥—Ä–µ–π–¥—ã —é–Ω–∏—Ç–æ–≤</div>
                    <div>E - –≠–≤–æ–ª—é—Ü–∏—è | –ü—Ä–æ–±–µ–ª - –°–ø–µ—Ü</div>
                </div>
                <div class="player-controls p2">
                    <h4>–ò–≥—Ä–æ–∫ 2 (–ª–æ–∫–∞–ª)</h4>
                    <div>7, 8, 9 - –Æ–Ω–∏—Ç—ã</div>
                    <div>I, O, P - –ê–ø–≥—Ä–µ–π–¥—ã –±–∞–∑—ã</div>
                    <div>J, K, L - –ê–ø–≥—Ä–µ–π–¥—ã —é–Ω–∏—Ç–æ–≤</div>
                    <div>U - –≠–≤–æ–ª—é—Ü–∏—è | Enter - –°–ø–µ—Ü</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–ì–†–ê -->
    <div id="gameArea" style="display: none;">
        <h1>Age of Wars <span id="playerBadge"></span></h1>

        <div id="gameContainer">
            <canvas id="gameCanvas" width="1000" height="400"></canvas>
        </div>

        <!-- UI –ò–≥—Ä–æ–∫ 1 -->
        <div id="ui1" class="ui-panel">
            <div id="healthBars">
                <div class="health-container">
                    <div class="health-label">
                        <span id="p1Label">–ò–≥—Ä–æ–∫ 1</span>
                        <span id="p1HpNum"></span>
                    </div>
                    <div class="health-bar">
                        <div class="health-fill player-health" id="p1HealthBar"></div>
                    </div>
                </div>
                <div class="health-container">
                    <div class="health-label">
                        <span id="p2Label">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</span>
                        <span id="p2HpNum"></span>
                    </div>
                    <div class="health-bar">
                        <div class="health-fill enemy-health" id="p2HealthBar"></div>
                    </div>
                </div>
            </div>

            <div id="statsBar">
                <span id="waveInfo" style="display:none;">–í–æ–ª–Ω–∞ 1</span>
                –£–±–∏–π—Å—Ç–≤: <span id="killCount">0</span> |
                –í—Ä–µ–º—è: <span id="gameTime">0:00</span>
            </div>

            <div class="xp-bar">
                <div class="health-label">
                    <span>–û–ø—ã—Ç</span>
                    <span id="xpText1">0 / 120</span>
                </div>
                <div class="xp-container">
                    <div class="xp-fill" id="xpFill1"></div>
                </div>
            </div>

            <div id="topBar" class="topBar">
                <div class="resource">–ó–æ–ª–æ—Ç–æ: <span id="gold1">50</span></div>
                <div class="eraDisplay" id="eraDisplay1">–ö–∞–º–µ–Ω–Ω—ã–π –≤–µ–∫</div>
                <div class="resource">+<span id="income1">8</span>/—Å</div>
            </div>

            <div class="controls" id="controls1"></div>
        </div>

        <!-- UI –ò–≥—Ä–æ–∫ 2 (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞) -->
        <div id="ui2" class="ui-panel p2" style="display: none;">
            <div class="xp-bar">
                <div class="health-label">
                    <span>–û–ø—ã—Ç (–ò–≥—Ä–æ–∫ 2)</span>
                    <span id="xpText2">0 / 120</span>
                </div>
                <div class="xp-container">
                    <div class="xp-fill p2" id="xpFill2"></div>
                </div>
            </div>

            <div class="topBar">
                <div class="resource p2">–ó–æ–ª–æ—Ç–æ: <span id="gold2">50</span></div>
                <div class="eraDisplay p2" id="eraDisplay2">–ö–∞–º–µ–Ω–Ω—ã–π –≤–µ–∫</div>
                <div class="resource p2">+<span id="income2">8</span>/—Å</div>
            </div>

            <div class="controls" id="controls2"></div>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="gameOver">
        <h2 id="gameOverTitle"></h2>
        <div class="stats" id="gameOverStats"></div>
        <button id="restartBtn" onclick="location.reload()">–í –º–µ–Ω—é</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ==================== –ö–û–ù–°–¢–ê–ù–¢–´ ====================
        const BALANCE = {
            startGold: 50,
            baseIncome: 8,
            incomePerLevel: 2,  // +2 –¥–æ—Ö–æ–¥–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å (–º–∞–∫—Å +38)
            baseHp: 1500,
            baseHpPerUpgrade: 100,  // +100 HP –∑–∞ —É—Ä–æ–≤–µ–Ω—å (–º–∞–∫—Å +1900)
            turret: {
                baseCooldown: 1800, cooldownReduction: 40, minCooldown: 600,  // –∫—É–ª–¥–∞—É–Ω —Å–Ω–∏–∂–∞–µ—Ç—Å—è –ø–ª–∞–≤–Ω–æ
                baseDamage: 15, damagePerLevel: 3, damagePerEra: 6, range: 350, maxLevel: 20
            },
            upgrades: {
                // –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç –ø–ª–∞–≤–Ω–æ: —É—Ä–æ–≤–µ–Ω—å 1=–±–∞–∑–æ–≤–∞—è, —É—Ä–æ–≤–µ–Ω—å 20 –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 15-20 —Ä–∞–∑ –¥–æ—Ä–æ–∂–µ
                turret: { baseCost: 25, costMultiplier: 1.18 },   // 25 ‚Üí 460 –Ω–∞ 20 —É—Ä–æ–≤–Ω–µ
                income: { baseCost: 30, costMultiplier: 1.20 },   // 30 ‚Üí 710 –Ω–∞ 20 —É—Ä–æ–≤–Ω–µ
                baseHp: { baseCost: 35, costMultiplier: 1.17 }    // 35 ‚Üí 560 –Ω–∞ 20 —É—Ä–æ–≤–Ω–µ
            },
            maxUpgradeLevel: 20,
            unitUpgrades: {
                attack: { baseCost: 20, costMultiplier: 1.18, bonusPerLevel: 0.05 },   // +5% –∞—Ç–∞–∫–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å (–º–∞–∫—Å +95%)
                health: { baseCost: 20, costMultiplier: 1.18, bonusPerLevel: 0.05 },   // +5% HP –∑–∞ —É—Ä–æ–≤–µ–Ω—å (–º–∞–∫—Å +95%)
                regen: { baseCost: 25, costMultiplier: 1.20, regenPerLevel: 1 }        // +1 —Ä–µ–≥–µ–Ω –∑–∞ —É—Ä–æ–≤–µ–Ω—å (–º–∞–∫—Å +19)
            },
            maxUnitUpgradeLevel: 20,
            special: { cost: 250, cooldown: 45000, unitDamage: 100, baseDamage: 50 },
            xp: { perDamageToUnit: 0.15, perDamageToBase: 0.25, perKill: 5 },
            ai: { minSpawnDelay: 2500, maxSpawnDelay: 4500, evolutionTimes: [0, 60000, 150000, 280000, 450000] },
            waves: { timeBetweenWaves: 25000, bossEveryNWaves: 5, difficultyScale: 1.15 }
        };

        const ERAS = [
            { name: '–ö–∞–º–µ–Ω–Ω—ã–π –≤–µ–∫', xpRequired: 0, units: [
                { name: '–î—É–±–∏–Ω—â–∏–∫', cost: 20, hp: 60, damage: 10, speed: 1.8, range: 30, attackSpeed: 800, color: '#8B4513', size: 20 },
                { name: '–ö–æ–ø–µ–π—â–∏–∫', cost: 40, hp: 90, damage: 15, speed: 1.3, range: 45, attackSpeed: 1000, color: '#A0522D', size: 22 },
                { name: '–ö–∞–º–Ω–µ–º—ë—Ç', cost: 55, hp: 45, damage: 22, speed: 1.0, range: 120, attackSpeed: 1400, color: '#6B4423', size: 18 }
            ]},
            { name: '–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ', xpRequired: 120, units: [
                { name: '–ú–µ—á–Ω–∏–∫', cost: 30, hp: 100, damage: 18, speed: 1.6, range: 35, attackSpeed: 850, color: '#4169E1', size: 22 },
                { name: '–†—ã—Ü–∞—Ä—å', cost: 75, hp: 200, damage: 28, speed: 1.1, range: 40, attackSpeed: 1200, color: '#C0C0C0', size: 28 },
                { name: '–õ—É—á–Ω–∏–∫', cost: 50, hp: 55, damage: 24, speed: 1.3, range: 160, attackSpeed: 1300, color: '#228B22', size: 20 }
            ]},
            { name: '–≠–ø–æ—Ö–∞ –ø–æ—Ä–æ—Ö–∞', xpRequired: 350, units: [
                { name: '–ú—É—à–∫–µ—Ç—ë—Ä', cost: 45, hp: 80, damage: 32, speed: 1.4, range: 180, attackSpeed: 1500, color: '#8B0000', size: 22 },
                { name: '–ö–∞–≤–∞–ª–µ—Ä–∏—è', cost: 90, hp: 160, damage: 38, speed: 2.0, range: 40, attackSpeed: 1000, color: '#DAA520', size: 30 },
                { name: '–ö–∞–Ω–æ–Ω–∏—Ä', cost: 120, hp: 100, damage: 55, speed: 0.7, range: 200, attackSpeed: 2200, color: '#2F4F4F', size: 25 }
            ]},
            { name: '–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å', xpRequired: 700, units: [
                { name: '–°–æ–ª–¥–∞—Ç', cost: 55, hp: 100, damage: 42, speed: 1.7, range: 200, attackSpeed: 1100, color: '#556B2F', size: 22 },
                { name: '–¢–∞–Ω–∫', cost: 180, hp: 400, damage: 65, speed: 0.8, range: 150, attackSpeed: 1800, color: '#3D5C3D', size: 40 },
                { name: '–°–Ω–∞–π–ø–µ—Ä', cost: 100, hp: 60, damage: 90, speed: 1.0, range: 280, attackSpeed: 2000, color: '#708090', size: 20 }
            ]},
            { name: '–ë—É–¥—É—â–µ–µ', xpRequired: 1200, units: [
                { name: '–ö–∏–±–æ—Ä–≥', cost: 80, hp: 150, damage: 55, speed: 1.9, range: 200, attackSpeed: 900, color: '#00CED1', size: 24 },
                { name: '–ú–µ—Ö', cost: 250, hp: 550, damage: 85, speed: 0.9, range: 180, attackSpeed: 1600, color: '#9400D3', size: 45 },
                { name: '–î—Ä–æ–Ω', cost: 130, hp: 75, damage: 110, speed: 2.2, range: 250, attackSpeed: 1700, color: '#FF4500', size: 18 }
            ]}
        ];

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let socket = null;
        let gameMode = null; // 'ai', 'online', 'local'
        let myPlayerNum = 1;
        let game = null;
        let nextUnitId = 0;
        let lastTime = 0;
        let aiSpawnTimer = 3000;
        let waveTimer = 25000;
        let wave = 1;

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ ====================
        function createPlayerState(num) {
            return {
                num,
                gold: BALANCE.startGold,
                xp: 0,
                era: 0,
                income: BALANCE.baseIncome,
                base: { hp: BALANCE.baseHp, maxHp: BALANCE.baseHp, x: num === 1 ? 50 : 950, turretCooldown: 0 },
                turretLevel: 1, incomeLevel: 1, baseHpLevel: 1,
                unitAttackLevel: 1, unitHealthLevel: 1, unitRegenLevel: 0,
                specialCooldown: 0, kills: 0
            };
        }

        function initGame() {
            game = {
                players: { 1: createPlayerState(1), 2: createPlayerState(2) },
                units: [],
                projectiles: [],
                effects: [],
                damageNumbers: [],
                gameTime: 0,
                winner: null
            };
            nextUnitId = 0;
            aiSpawnTimer = 3000;
            waveTimer = BALANCE.waves.timeBetweenWaves;
            wave = 1;
        }

        // ==================== –°–¢–ê–†–¢ –ò–ì–† ====================
        function startGame(mode) {
            gameMode = mode;
            myPlayerNum = 1;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('gameArea').style.display = 'flex';
            document.getElementById('gameArea').style.flexDirection = 'column';
            document.getElementById('gameArea').style.alignItems = 'center';

            const badge = document.getElementById('playerBadge');
            if (mode === 'ai') {
                badge.textContent = '(vs AI)';
                badge.style.color = '#38ef7d';
                document.getElementById('p2Label').textContent = '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ (AI)';
                document.getElementById('waveInfo').style.display = 'inline';
            } else if (mode === 'local') {
                badge.textContent = '(–õ–æ–∫–∞–ª—å–Ω–æ)';
                badge.style.color = '#f5576c';
                document.getElementById('p2Label').textContent = '–ò–≥—Ä–æ–∫ 2';
                document.getElementById('ui2').style.display = 'block';
            }

            initGame();
            buildControls(1);
            if (mode === 'local') buildControls(2);
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function startOnline() {
            gameMode = 'online';
            document.getElementById('status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            document.getElementById('onlineBtn').disabled = true;

            socket = io();

            socket.on('connect', () => {
                document.getElementById('status').textContent = '–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
                socket.emit('joinGame');
            });

            socket.on('joined', (data) => {
                myPlayerNum = data.playerNum;
                if (data.waiting) {
                    document.getElementById('status').textContent = `–¢—ã - –ò–≥—Ä–æ–∫ ${myPlayerNum}. –û–∂–∏–¥–∞–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...`;
                }
            });

            socket.on('gameStart', (data) => {
                game = data.game;
                document.getElementById('menu').style.display = 'none';
                document.getElementById('gameArea').style.display = 'flex';
                document.getElementById('gameArea').style.flexDirection = 'column';
                document.getElementById('gameArea').style.alignItems = 'center';

                const badge = document.getElementById('playerBadge');
                badge.textContent = `(–û–Ω–ª–∞–π–Ω - –ò–≥—Ä–æ–∫ ${myPlayerNum})`;
                badge.style.color = myPlayerNum === 1 ? '#38ef7d' : '#f5576c';

                document.getElementById('p1Label').textContent = '–ò–≥—Ä–æ–∫ 1';
                document.getElementById('p2Label').textContent = '–ò–≥—Ä–æ–∫ 2';

                buildControls(1);
                requestAnimationFrame(renderLoop);
            });

            socket.on('gameState', (state) => {
                game = state;
                updateUI();
            });

            socket.on('gameOver', (data) => {
                showGameOver(data.winner === myPlayerNum);
            });

            socket.on('opponentLeft', () => {
                alert('–°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è!');
                location.reload();
            });
        }

        // ==================== –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê (–¥–ª—è offline) ====================
        function gameLoop(timestamp) {
            if (game.winner) return;

            const delta = timestamp - lastTime;
            lastTime = timestamp;

            updateGameLogic(delta);
            updateUI();
            render();

            if (!game.winner) {
                requestAnimationFrame(gameLoop);
            }
        }

        function renderLoop() {
            updateUI();
            render();
            if (!game.winner) {
                requestAnimationFrame(renderLoop);
            }
        }

        function updateGameLogic(delta) {
            game.gameTime += delta;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤
            for (const num of [1, 2]) {
                const p = game.players[num];
                p.gold += p.income * (delta / 1000);
                if (p.specialCooldown > 0) p.specialCooldown -= delta;
                if (p.base.turretCooldown > 0) p.base.turretCooldown -= delta;

                // –°—Ç—Ä–µ–ª—å–±–∞ —Ç—É—Ä–µ–ª–∏
                if (p.base.turretCooldown <= 0) {
                    const enemyNum = num === 1 ? 2 : 1;
                    const target = findTurretTarget(p, enemyNum);
                    if (target) {
                        const dmg = BALANCE.turret.baseDamage + (p.turretLevel - 1) * BALANCE.turret.damagePerLevel + p.era * BALANCE.turret.damagePerEra;
                        target.hp -= dmg;
                        p.xp += dmg * BALANCE.xp.perDamageToUnit;
                        game.projectiles.push({ x: p.base.x, y: 280, targetX: target.x, targetY: target.y, owner: num, life: 200 });
                        p.base.turretCooldown = Math.max(BALANCE.turret.minCooldown, BALANCE.turret.baseCooldown - (p.turretLevel - 1) * BALANCE.turret.cooldownReduction);
                    }
                }
            }

            // AI –ª–æ–≥–∏–∫–∞
            if (gameMode === 'ai') {
                updateAI(delta);
                updateWaves(delta);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —é–Ω–∏—Ç–æ–≤
            for (const unit of game.units) {
                if (unit.regen > 0 && unit.hp < unit.maxHp) {
                    unit.hp = Math.min(unit.maxHp, unit.hp + unit.regen * (delta / 1000));
                }
                if (unit.attackCooldown > 0) unit.attackCooldown -= delta;

                const enemyNum = unit.owner === 1 ? 2 : 1;
                const enemyBase = game.players[enemyNum].base;
                const target = findTarget(unit, enemyNum, enemyBase);

                if (target) {
                    if (unit.attackCooldown <= 0) {
                        if (target.isBase) {
                            target.hp -= unit.damage;
                            game.players[unit.owner].xp += unit.damage * BALANCE.xp.perDamageToBase;
                        } else {
                            target.hp -= unit.damage;
                            game.players[unit.owner].xp += unit.damage * BALANCE.xp.perDamageToUnit;
                            if (target.hp <= 0) {
                                game.players[unit.owner].kills++;
                                game.players[unit.owner].xp += BALANCE.xp.perKill;
                            }
                        }
                        unit.attackCooldown = unit.attackSpeed;
                    }
                } else {
                    unit.x += unit.speed * unit.direction * (delta / 16);
                }
            }

            // –£–¥–∞–ª—è–µ–º –º—ë—Ä—Ç–≤—ã—Ö
            game.units = game.units.filter(u => u.hp > 0);

            // –°–Ω–∞—Ä—è–¥—ã
            game.projectiles = game.projectiles.filter(p => { p.life -= delta; return p.life > 0; });

            // –≠—Ñ—Ñ–µ–∫—Ç—ã
            game.effects = game.effects.filter(e => { e.timer--; return e.timer > 0; });

            // –ß–∏—Å–ª–∞ —É—Ä–æ–Ω–∞
            game.damageNumbers = game.damageNumbers.filter(d => {
                d.timer--;
                d.y -= 1;
                return d.timer > 0;
            });

            // –ü–æ–±–µ–¥–∞
            if (game.players[1].base.hp <= 0) {
                game.winner = 2;
                showGameOver(myPlayerNum === 2);
            } else if (game.players[2].base.hp <= 0) {
                game.winner = 1;
                showGameOver(myPlayerNum === 1);
            }
        }

        function findTurretTarget(player, enemyNum) {
            let closest = null, closestDist = BALANCE.turret.range;
            for (const unit of game.units) {
                if (unit.owner !== enemyNum) continue;
                const dist = Math.abs(unit.x - player.base.x);
                if (dist < closestDist) { closestDist = dist; closest = unit; }
            }
            return closest;
        }

        function findTarget(unit, enemyNum, enemyBase) {
            for (const enemy of game.units) {
                if (enemy.owner !== enemyNum) continue;
                if (Math.abs(enemy.x - unit.x) <= unit.range) return enemy;
            }
            if (Math.abs(unit.x - enemyBase.x) <= unit.range) return { ...enemyBase, isBase: true };
            return null;
        }

        // ==================== AI ====================
        function updateAI(delta) {
            const ai = game.players[2];
            ai.gold += 5 * (delta / 1000); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ AI

            // –≠–≤–æ–ª—é—Ü–∏—è AI
            for (let i = ERAS.length - 1; i > ai.era; i--) {
                if (game.gameTime > BALANCE.ai.evolutionTimes[i] && ai.xp >= ERAS[i].xpRequired) {
                    ai.era = i;
                    break;
                }
            }

            // –°–ø–∞–≤–Ω —é–Ω–∏—Ç–æ–≤
            aiSpawnTimer -= delta;
            if (aiSpawnTimer <= 0) {
                const era = ERAS[ai.era];
                const affordable = era.units.filter(u => ai.gold >= u.cost);
                if (affordable.length > 0) {
                    const unit = affordable[Math.floor(Math.random() * affordable.length)];
                    const idx = era.units.indexOf(unit);
                    spawnUnit(2, idx);
                }
                aiSpawnTimer = BALANCE.ai.minSpawnDelay + Math.random() * (BALANCE.ai.maxSpawnDelay - BALANCE.ai.minSpawnDelay);
            }

            // AI –∞–ø–≥—Ä–µ–π–¥—ã
            if (ai.gold > 200 && Math.random() < 0.01) {
                const upgrades = ['turret', 'income', 'baseHp'];
                doUpgrade(2, upgrades[Math.floor(Math.random() * upgrades.length)]);
            }
        }

        function updateWaves(delta) {
            waveTimer -= delta;
            if (waveTimer <= 0) {
                wave++;
                waveTimer = BALANCE.waves.timeBetweenWaves;
                document.getElementById('waveInfo').textContent = `–í–æ–ª–Ω–∞ ${wave}`;

                // –°–ø–∞–≤–Ω–∏–º –≤–æ–ª–Ω—É –≤—Ä–∞–≥–æ–≤
                const count = Math.min(3 + Math.floor(wave / 2), 8);
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        if (!game.winner) {
                            const era = ERAS[game.players[2].era];
                            const idx = Math.floor(Math.random() * era.units.length);
                            spawnUnit(2, idx);
                        }
                    }, i * 500);
                }
            }
        }

        // ==================== –î–ï–ô–°–¢–í–ò–Ø ====================
        function spawnUnit(playerNum, unitIndex) {
            const p = game.players[playerNum];
            const era = ERAS[p.era];
            const def = era.units[unitIndex];
            if (!def || p.gold < def.cost) return false;

            p.gold -= def.cost;
            const attackMult = 1 + (p.unitAttackLevel - 1) * BALANCE.unitUpgrades.attack.bonusPerLevel;
            const healthMult = 1 + (p.unitHealthLevel - 1) * BALANCE.unitUpgrades.health.bonusPerLevel;
            const isP1 = playerNum === 1;

            game.units.push({
                id: nextUnitId++,
                owner: playerNum,
                x: isP1 ? 80 : 920,
                y: 320,
                hp: Math.floor(def.hp * healthMult),
                maxHp: Math.floor(def.hp * healthMult),
                damage: Math.floor(def.damage * attackMult),
                speed: def.speed,
                range: def.range,
                attackSpeed: def.attackSpeed,
                attackCooldown: 0,
                color: isP1 ? def.color : shiftColor(def.color),
                size: def.size,
                direction: isP1 ? 1 : -1,
                regen: p.unitRegenLevel * BALANCE.unitUpgrades.regen.regenPerLevel,
                name: def.name
            });
            return true;
        }

        function shiftColor(hex) {
            let r = parseInt(hex.slice(1,3), 16);
            let g = parseInt(hex.slice(3,5), 16);
            let b = parseInt(hex.slice(5,7), 16);
            r = Math.min(255, r + 60);
            g = Math.max(0, g - 30);
            return `rgb(${r},${g},${b})`;
        }

        function getUpgradeCost(type, level) {
            const cfg = BALANCE.upgrades[type];
            return Math.floor(cfg.baseCost * Math.pow(cfg.costMultiplier, level - 1));
        }

        function getUnitUpgradeCost(type, level) {
            const cfg = BALANCE.unitUpgrades[type];
            return Math.floor(cfg.baseCost * Math.pow(cfg.costMultiplier, level - 1));
        }

        function doUpgrade(playerNum, type) {
            const p = game.players[playerNum];
            let cost, level, max;

            if (['turret', 'income', 'baseHp'].includes(type)) {
                level = p[type + 'Level'];
                max = BALANCE.maxUpgradeLevel;
                cost = getUpgradeCost(type, level);
            } else {
                const key = 'unit' + type.charAt(0).toUpperCase() + type.slice(1) + 'Level';
                level = p[key];
                max = BALANCE.maxUnitUpgradeLevel;
                cost = getUnitUpgradeCost(type, level);
            }

            if (level >= max || p.gold < cost) return false;
            p.gold -= cost;

            if (type === 'turret') p.turretLevel++;
            else if (type === 'income') { p.incomeLevel++; p.income = BALANCE.baseIncome + (p.incomeLevel - 1) * BALANCE.incomePerLevel; }
            else if (type === 'baseHp') { p.baseHpLevel++; p.base.maxHp += BALANCE.baseHpPerUpgrade; p.base.hp += BALANCE.baseHpPerUpgrade; }
            else if (type === 'attack') p.unitAttackLevel++;
            else if (type === 'health') p.unitHealthLevel++;
            else if (type === 'regen') p.unitRegenLevel++;

            return true;
        }

        function doEvolve(playerNum) {
            const p = game.players[playerNum];
            if (p.era >= ERAS.length - 1) return false;
            const next = ERAS[p.era + 1];
            if (p.xp >= next.xpRequired) { p.era++; return true; }
            return false;
        }

        function doSpecial(playerNum) {
            const p = game.players[playerNum];
            if (p.gold < BALANCE.special.cost || p.specialCooldown > 0) return false;
            p.gold -= BALANCE.special.cost;
            p.specialCooldown = BALANCE.special.cooldown;

            const enemyNum = playerNum === 1 ? 2 : 1;
            game.units.forEach(u => {
                if (u.owner === enemyNum) {
                    u.hp -= BALANCE.special.unitDamage;
                    addDamageNumber(u.x, u.y - 30, BALANCE.special.unitDamage, '#FF6600');
                }
            });
            const enemyBase = game.players[enemyNum].base;
            enemyBase.hp -= BALANCE.special.baseDamage;
            addDamageNumber(enemyBase.x, 180, BALANCE.special.baseDamage, '#FF6600');

            // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç
            game.effects.push({ type: 'special', x: canvas.width / 2, y: 200, timer: 40 });
            return true;
        }

        function addDamageNumber(x, y, damage, color) {
            game.damageNumbers.push({ x, y, damage, color, timer: 45 });
        }

        function doAction(playerNum, type, payload) {
            if (gameMode === 'online') {
                socket.emit('action', { type, payload });
            } else {
                if (type === 'spawnUnit') spawnUnit(playerNum, payload.unitIndex);
                else if (type === 'upgrade') doUpgrade(playerNum, payload.upgradeType);
                else if (type === 'evolve') doEvolve(playerNum);
                else if (type === 'special') doSpecial(playerNum);
            }
        }

        // ==================== UI ====================
        function buildControls(playerNum) {
            const controls = document.getElementById('controls' + playerNum);
            controls.innerHTML = '';
            const keys = playerNum === 1 ? ['1','2','3','Q','W','R','A','S','D','E','Space'] : ['7','8','9','I','O','P','J','K','L','U','Enter'];

            // –Æ–Ω–∏—Ç—ã
            for (let i = 0; i < 3; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn unit-btn';
                btn.dataset.player = playerNum;
                btn.dataset.unit = i;
                btn.innerHTML = `Unit ${i+1} <span class="hotkey">${keys[i]}</span>`;
                btn.onclick = () => doAction(playerNum, 'spawnUnit', { unitIndex: i });
                controls.appendChild(btn);
            }

            controls.appendChild(createSeparator());

            // –ê–ø–≥—Ä–µ–π–¥—ã –±–∞–∑—ã
            ['turret', 'income', 'baseHp'].forEach((type, i) => {
                const labels = ['–¢—É—Ä–µ–ª—å', '–î–æ—Ö–æ–¥', 'HP –±–∞–∑—ã'];
                const btn = document.createElement('button');
                btn.className = 'btn upgrade-btn';
                btn.dataset.player = playerNum;
                btn.dataset.upgrade = type;
                btn.innerHTML = `${labels[i]} <span class="hotkey">${keys[3+i]}</span>`;
                btn.onclick = () => doAction(playerNum, 'upgrade', { upgradeType: type });
                controls.appendChild(btn);
            });

            controls.appendChild(createSeparator());

            // –ê–ø–≥—Ä–µ–π–¥—ã —é–Ω–∏—Ç–æ–≤
            ['attack', 'health', 'regen'].forEach((type, i) => {
                const labels = ['–ê—Ç–∞–∫–∞', 'HP', '–†–µ–≥–µ–Ω'];
                const btn = document.createElement('button');
                btn.className = 'btn upgrade-btn';
                btn.dataset.player = playerNum;
                btn.dataset.unitUpgrade = type;
                btn.innerHTML = `${labels[i]} <span class="hotkey">${keys[6+i]}</span>`;
                btn.onclick = () => doAction(playerNum, 'upgrade', { upgradeType: type });
                controls.appendChild(btn);
            });

            controls.appendChild(createSeparator());

            // –≠–≤–æ–ª—é—Ü–∏—è
            const evolveBtn = document.createElement('button');
            evolveBtn.className = 'btn evolve-btn';
            evolveBtn.id = 'evolveBtn' + playerNum;
            evolveBtn.innerHTML = `–≠–≤–æ–ª—é—Ü–∏—è <span class="hotkey">${keys[9]}</span>`;
            evolveBtn.onclick = () => doAction(playerNum, 'evolve', {});
            controls.appendChild(evolveBtn);

            // –°–ø–µ—Ü
            const specialBtn = document.createElement('button');
            specialBtn.className = 'btn special-btn';
            specialBtn.id = 'specialBtn' + playerNum;
            specialBtn.innerHTML = `–°–ø–µ—Ü 250g <span class="hotkey">${keys[10]}</span>`;
            specialBtn.onclick = () => doAction(playerNum, 'special', {});
            controls.appendChild(specialBtn);
        }

        function createSeparator() {
            const sep = document.createElement('div');
            sep.className = 'separator';
            return sep;
        }

        function updateUI() {
            if (!game) return;

            // –î–ª—è –æ–Ω–ª–∞–π–Ω –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ–π playerNum, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî –∏–≥—Ä–æ–∫ 1
            const displayPlayer = gameMode === 'online' ? myPlayerNum : 1;
            updatePlayerUI(displayPlayer, 1);

            if (gameMode === 'local') {
                updatePlayerUI(2, 2);
            }

            // HP –±–∞–∑
            const p1 = game.players[1], p2 = game.players[2];
            document.getElementById('p1HpNum').textContent = `${Math.floor(p1.base.hp)} / ${p1.base.maxHp}`;
            document.getElementById('p2HpNum').textContent = `${Math.floor(p2.base.hp)} / ${p2.base.maxHp}`;
            document.getElementById('p1HealthBar').style.width = `${Math.max(0, p1.base.hp / p1.base.maxHp) * 100}%`;
            document.getElementById('p2HealthBar').style.width = `${Math.max(0, p2.base.hp / p2.base.maxHp) * 100}%`;

            // –°—Ç–∞—Ç—ã
            const me = game.players[displayPlayer];
            document.getElementById('killCount').textContent = me.kills;
            const secs = Math.floor(game.gameTime / 1000);
            document.getElementById('gameTime').textContent = `${Math.floor(secs/60)}:${(secs%60).toString().padStart(2,'0')}`;
        }

        function updatePlayerUI(playerNum, uiNum) {
            const p = game.players[playerNum];
            const era = ERAS[p.era];

            document.getElementById('gold' + uiNum).textContent = Math.floor(p.gold);
            document.getElementById('income' + uiNum).textContent = p.income;
            document.getElementById('eraDisplay' + uiNum).textContent = era.name;

            const nextEra = ERAS[p.era + 1];
            const xpNeeded = nextEra ? nextEra.xpRequired : p.xp;
            document.getElementById('xpText' + uiNum).textContent = `${Math.floor(p.xp)} / ${xpNeeded}`;
            document.getElementById('xpFill' + uiNum).style.width = `${Math.min(100, (p.xp / xpNeeded) * 100)}%`;

            // –ö–Ω–æ–ø–∫–∏ —é–Ω–∏—Ç–æ–≤
            document.querySelectorAll(`[data-player="${uiNum}"][data-unit]`).forEach((btn, i) => {
                const unit = era.units[i];
                const keys = uiNum === 1 ? ['1','2','3'] : ['7','8','9'];
                btn.innerHTML = `${unit.name} ${unit.cost}g <span class="hotkey">${keys[i]}</span>`;
                btn.classList.toggle('affordable', p.gold >= unit.cost);
                btn.disabled = p.gold < unit.cost;
            });

            // –ê–ø–≥—Ä–µ–π–¥—ã –±–∞–∑—ã (–¢—É—Ä–µ–ª—å, –î–æ—Ö–æ–¥, HP –±–∞–∑—ã)
            const baseUpgradeKeys = uiNum === 1 ? ['Q','W','R'] : ['I','O','P'];
            const baseUpgradeTypes = ['turret', 'income', 'baseHp'];
            const baseUpgradeLabels = ['–¢—É—Ä–µ–ª—å', '–î–æ—Ö–æ–¥', 'HP'];
            document.querySelectorAll(`[data-player="${uiNum}"][data-upgrade]`).forEach((btn, i) => {
                const type = baseUpgradeTypes[i];
                const level = p[type + 'Level'];
                const maxLevel = BALANCE.maxUpgradeLevel;
                if (level >= maxLevel) {
                    btn.innerHTML = `${baseUpgradeLabels[i]} <span class="level">MAX</span>`;
                    btn.disabled = true;
                    btn.classList.remove('affordable');
                } else {
                    const cost = getUpgradeCost(type, level);
                    btn.innerHTML = `${baseUpgradeLabels[i]} <span class="level">${level}</span> ${cost}g <span class="hotkey">${baseUpgradeKeys[i]}</span>`;
                    btn.classList.toggle('affordable', p.gold >= cost);
                    btn.disabled = p.gold < cost;
                }
            });

            // –ê–ø–≥—Ä–µ–π–¥—ã —é–Ω–∏—Ç–æ–≤ (–ê—Ç–∞–∫–∞, HP, –†–µ–≥–µ–Ω)
            const unitUpgradeKeys = uiNum === 1 ? ['A','S','D'] : ['J','K','L'];
            const unitUpgradeTypes = ['attack', 'health', 'regen'];
            const unitUpgradeLabels = ['–ê—Ç–∫', '–•–ü', '–†–µ–≥'];
            document.querySelectorAll(`[data-player="${uiNum}"][data-unit-upgrade]`).forEach((btn, i) => {
                const type = unitUpgradeTypes[i];
                const key = 'unit' + type.charAt(0).toUpperCase() + type.slice(1) + 'Level';
                const level = p[key];
                const maxLevel = BALANCE.maxUnitUpgradeLevel;
                if (level >= maxLevel) {
                    btn.innerHTML = `${unitUpgradeLabels[i]} <span class="level">MAX</span>`;
                    btn.disabled = true;
                    btn.classList.remove('affordable');
                } else {
                    const cost = getUnitUpgradeCost(type, level);
                    btn.innerHTML = `${unitUpgradeLabels[i]} <span class="level">${level}</span> ${cost}g <span class="hotkey">${unitUpgradeKeys[i]}</span>`;
                    btn.classList.toggle('affordable', p.gold >= cost);
                    btn.disabled = p.gold < cost;
                }
            });

            // –≠–≤–æ–ª—é—Ü–∏—è
            const evolveBtn = document.getElementById('evolveBtn' + uiNum);
            if (p.era >= ERAS.length - 1) {
                evolveBtn.textContent = 'MAX';
                evolveBtn.disabled = true;
            } else {
                const next = ERAS[p.era + 1];
                const key = uiNum === 1 ? 'E' : 'U';
                evolveBtn.innerHTML = `–≠–≤–æ–ª (${next.xpRequired} XP) <span class="hotkey">${key}</span>`;
                evolveBtn.disabled = p.xp < next.xpRequired;
                evolveBtn.classList.toggle('affordable', p.xp >= next.xpRequired);
            }

            // –°–ø–µ—Ü
            const specialBtn = document.getElementById('specialBtn' + uiNum);
            const key = uiNum === 1 ? 'Space' : 'Enter';
            if (p.specialCooldown > 0) {
                specialBtn.innerHTML = `–°–ø–µ—Ü (${Math.ceil(p.specialCooldown/1000)}—Å)`;
                specialBtn.disabled = true;
            } else {
                specialBtn.innerHTML = `–°–ø–µ—Ü 250g <span class="hotkey">${key}</span>`;
                specialBtn.disabled = p.gold < 250;
                specialBtn.classList.toggle('affordable', p.gold >= 250);
            }
        }

        function showGameOver(isWin) {
            const overlay = document.getElementById('gameOver');
            const title = document.getElementById('gameOverTitle');
            overlay.className = isWin ? 'victory' : 'defeat';
            title.textContent = isWin ? '–ü–û–ë–ï–î–ê!' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';
            const me = game.players[myPlayerNum];
            document.getElementById('gameOverStats').textContent = `–£–±–∏–π—Å—Ç–≤: ${me.kills} | –≠—Ä–∞: ${ERAS[me.era].name}`;
            overlay.style.display = 'flex';
        }

        // ==================== –ö–õ–ê–í–ò–ê–¢–£–†–ê ====================
        document.addEventListener('keydown', (e) => {
            if (!game || game.winner) return;

            const key = e.key.toLowerCase();

            // –ò–≥—Ä–æ–∫ 1
            if (key === '1') doAction(1, 'spawnUnit', { unitIndex: 0 });
            else if (key === '2') doAction(1, 'spawnUnit', { unitIndex: 1 });
            else if (key === '3') doAction(1, 'spawnUnit', { unitIndex: 2 });
            else if (key === 'q') doAction(1, 'upgrade', { upgradeType: 'turret' });
            else if (key === 'w') doAction(1, 'upgrade', { upgradeType: 'income' });
            else if (key === 'r') doAction(1, 'upgrade', { upgradeType: 'baseHp' });
            else if (key === 'a') doAction(1, 'upgrade', { upgradeType: 'attack' });
            else if (key === 's') doAction(1, 'upgrade', { upgradeType: 'health' });
            else if (key === 'd') doAction(1, 'upgrade', { upgradeType: 'regen' });
            else if (key === 'e') doAction(1, 'evolve', {});
            else if (key === ' ') { doAction(1, 'special', {}); e.preventDefault(); }

            // –ò–≥—Ä–æ–∫ 2 (—Ç–æ–ª—å–∫–æ local)
            if (gameMode === 'local') {
                if (key === '7') doAction(2, 'spawnUnit', { unitIndex: 0 });
                else if (key === '8') doAction(2, 'spawnUnit', { unitIndex: 1 });
                else if (key === '9') doAction(2, 'spawnUnit', { unitIndex: 2 });
                else if (key === 'i') doAction(2, 'upgrade', { upgradeType: 'turret' });
                else if (key === 'o') doAction(2, 'upgrade', { upgradeType: 'income' });
                else if (key === 'p') doAction(2, 'upgrade', { upgradeType: 'baseHp' });
                else if (key === 'j') doAction(2, 'upgrade', { upgradeType: 'attack' });
                else if (key === 'k') doAction(2, 'upgrade', { upgradeType: 'health' });
                else if (key === 'l') doAction(2, 'upgrade', { upgradeType: 'regen' });
                else if (key === 'u') doAction(2, 'evolve', {});
                else if (key === 'enter') { doAction(2, 'special', {}); e.preventDefault(); }
            }
        });

        // ==================== –†–ï–ù–î–ï–† ====================
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –§–æ–Ω
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.6, '#87CEEB');
            gradient.addColorStop(0.6, '#228B22');
            gradient.addColorStop(1, '#1a5f1a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –ë–∞–∑—ã
            drawBase(game.players[1], '#4169E1', '#1E3A8A');
            drawBase(game.players[2], '#DC143C', '#8B0000');

            // –Æ–Ω–∏—Ç—ã
            for (const unit of game.units) drawUnit(unit);

            // –°–Ω–∞—Ä—è–¥—ã
            for (const proj of game.projectiles) {
                ctx.beginPath();
                ctx.arc(proj.targetX, proj.targetY, 5, 0, Math.PI * 2);
                ctx.fillStyle = proj.owner === 1 ? '#FFD700' : '#FF4500';
                ctx.fill();
            }

            // –≠—Ñ—Ñ–µ–∫—Ç—ã
            for (const e of game.effects) {
                ctx.globalAlpha = e.timer / 40;
                if (e.type === 'special') {
                    const radius = (40 - e.timer) * 20;
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, radius, 0, Math.PI * 2);
                    ctx.strokeStyle = '#FF6600';
                    ctx.lineWidth = 10;
                    ctx.stroke();
                } else if (e.type === 'spawn') {
                    const radius = (20 - e.timer) * 2;
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, radius, 0, Math.PI * 2);
                    ctx.strokeStyle = '#00FF00';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                ctx.globalAlpha = 1;
            }

            // –ß–∏—Å–ª–∞ —É—Ä–æ–Ω–∞
            for (const d of game.damageNumbers) {
                ctx.globalAlpha = d.timer / 45;
                ctx.fillStyle = d.color;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('-' + d.damage, d.x, d.y);
                ctx.globalAlpha = 1;
            }
        }

        function drawBase(player, color, darkColor) {
            const x = player.base.x;
            const isP1 = player.num === 1;
            const dir = isP1 ? 1 : -1;
            const era = ERAS[player.era];
            const eraColors = ['#8B4513', '#708090', '#4A4A4A', '#2F4F4F', '#4B0082'];

            // –¢–µ–Ω—å
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x, 355, 50, 10, 0, 0, Math.PI * 2);
            ctx.fill();

            // –û—Å–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–º–∫–∞
            ctx.fillStyle = eraColors[player.era];
            ctx.fillRect(x - 45, 245, 90, 105);

            // –ö—Ä—ã—à–∞
            ctx.beginPath();
            ctx.moveTo(x - 55, 245);
            ctx.lineTo(x, 190);
            ctx.lineTo(x + 55, 245);
            ctx.fillStyle = isP1 ? '#006400' : '#8B0000';
            ctx.fill();
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.stroke();

            // –¢—É—Ä–µ–ª—å (—Ä–∞–∑–º–µ—Ä —Ä–∞—Å—Ç—ë—Ç –ø–ª–∞–≤–Ω–æ —Å 1 –¥–æ 20 —É—Ä–æ–≤–Ω—è)
            const turretLevel = player.turretLevel;
            const turretSize = 10 + turretLevel * 0.6;  // –æ—Ç 10.6 –¥–æ 22
            const barrelLen = 18 + turretLevel * 0.8;   // –æ—Ç 18.8 –¥–æ 34
            ctx.fillStyle = '#333';
            ctx.fillRect(x - turretSize / 2, 255, turretSize, turretSize);
            ctx.fillStyle = '#555';
            ctx.fillRect(x + dir * turretSize / 2, 258, barrelLen * dir, 6 + turretLevel * 0.15);

            // –§–ª–∞–≥
            ctx.fillStyle = '#5C4033';
            ctx.fillRect(x - 2, 170, 4, 25);
            const wave = Math.sin(Date.now() / 200) * 3;
            ctx.fillStyle = isP1 ? '#00FF00' : '#FF0000';
            ctx.beginPath();
            ctx.moveTo(x + 2, 170);
            ctx.lineTo(x + 25 + wave, 175);
            ctx.lineTo(x + 2, 182);
            ctx.fill();

            // HP –±–∞—Ä
            const hpPercent = Math.max(0, player.base.hp / player.base.maxHp);
            ctx.fillStyle = '#333';
            ctx.fillRect(x - 40, 160, 80, 10);
            ctx.fillStyle = isP1 ? '#38ef7d' : '#ef473a';
            ctx.fillRect(x - 40, 160, 80 * hpPercent, 10);
        }

        function drawUnit(unit) {
            const { x, y, size, color, hp, maxHp, owner, name } = unit;
            const isEnemy = owner === 2;
            const dir = isEnemy ? -1 : 1;

            // –¢–µ–Ω—å
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x, y + 5, size / 2, size / 6, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.save();
            ctx.translate(x, y);

            switch(name) {
                // ===== –ö–ê–ú–ï–ù–ù–´–ô –í–ï–ö =====
                case '–î—É–±–∏–Ω—â–∏–∫':
                    drawBody('#8B4513', size);
                    drawHead2(0, -size - 2, size/3.5, isEnemy);
                    ctx.fillStyle = '#4a3728';
                    for(let i = -2; i <= 2; i++) {
                        ctx.beginPath();
                        ctx.ellipse(i * 3, -size - 10, 3, 7, i * 0.2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    ctx.fillStyle = '#5C4033';
                    ctx.save();
                    ctx.translate(dir * 12, -size/2);
                    ctx.rotate(dir * 0.4);
                    ctx.fillRect(-2, -20, 5, 28);
                    ctx.fillStyle = '#3a2515';
                    ctx.beginPath();
                    ctx.arc(0, -22, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                    break;

                case '–ö–æ–ø–µ–π—â–∏–∫':
                    drawBody('#A0522D', size);
                    drawHead2(0, -size - 2, size/3.5, isEnemy);
                    ctx.fillStyle = '#8B0000';
                    ctx.fillRect(-7, -size - 8, 14, 4);
                    ctx.fillStyle = '#5C4033';
                    ctx.fillRect(dir * 10, -size - 15, 3, 40);
                    ctx.fillStyle = '#888';
                    ctx.beginPath();
                    ctx.moveTo(dir * 11.5, -size - 15);
                    ctx.lineTo(dir * 11.5 - 5, -size - 25);
                    ctx.lineTo(dir * 11.5 + 5, -size - 25);
                    ctx.fill();
                    break;

                case '–ö–∞–º–Ω–µ–º—ë—Ç':
                    ctx.fillStyle = '#6B4423';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2 + 3, size/2, size/2.2, 0, 0, Math.PI * 2);
                    ctx.fill();
                    drawHead2(0, -size + 2, size/3.2, isEnemy);
                    ctx.strokeStyle = '#5C4033';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(dir * 8, -size/2);
                    ctx.quadraticCurveTo(dir * 22, -size, dir * 14, -size - 12);
                    ctx.stroke();
                    ctx.fillStyle = '#666';
                    ctx.beginPath();
                    ctx.arc(dir * 14, -size - 12, 5, 0, Math.PI * 2);
                    ctx.fill();
                    break;

                // ===== –°–†–ï–î–ù–ï–í–ï–ö–û–í–¨–ï =====
                case '–ú–µ—á–Ω–∏–∫':
                    drawBody('#4169E1', size);
                    drawHead2(0, -size - 2, size/3.5, isEnemy);
                    ctx.fillStyle = '#708090';
                    ctx.beginPath();
                    ctx.arc(0, -size - 4, size/3, Math.PI, 0);
                    ctx.fill();
                    ctx.fillStyle = '#C0C0C0';
                    ctx.fillRect(dir * 12, -size/2 - 12, 3, 22);
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(dir * 12 - 3, -size/2 + 8, 9, 4);
                    break;

                case '–†—ã—Ü–∞—Ä—å':
                    ctx.fillStyle = '#B8B8B8';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2, size/2, size/1.7, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#A8A8A8';
                    ctx.beginPath();
                    ctx.arc(0, -size - 3, size/2.5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#333';
                    ctx.fillRect(-5, -size - 4, 10, 3);
                    ctx.fillStyle = '#FF0000';
                    ctx.beginPath();
                    ctx.ellipse(0, -size - size/2 - 5, 3, 10, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#C0C0C0';
                    ctx.fillRect(dir * 14, -size - 5, 4, 30);
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(dir * 14 - 4, -size/2 + 8, 12, 5);
                    break;

                case '–õ—É—á–Ω–∏–∫':
                    ctx.fillStyle = '#228B22';
                    ctx.beginPath();
                    ctx.moveTo(-8, -size + 8);
                    ctx.lineTo(8, -size + 8);
                    ctx.lineTo(6, 0);
                    ctx.lineTo(-6, 0);
                    ctx.fill();
                    drawBody('#228B22', size);
                    drawHead2(0, -size - 2, size/3.5, isEnemy);
                    ctx.fillStyle = '#1a6b1a';
                    ctx.beginPath();
                    ctx.arc(0, -size - 2, size/3, Math.PI * 0.75, Math.PI * 0.25);
                    ctx.fill();
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(dir * 14, -size/2, 15, -Math.PI/2, Math.PI/2);
                    ctx.stroke();
                    break;

                // ===== –≠–ü–û–•–ê –ü–û–†–û–•–ê =====
                case '–ú—É—à–∫–µ—Ç—ë—Ä':
                    drawBody('#8B0000', size);
                    ctx.fillStyle = '#FFD700';
                    for(let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.arc(0, -size/2 - 6 + i*6, 2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    drawHead2(0, -size - 2, size/3.5, isEnemy);
                    ctx.fillStyle = '#1a1a1a';
                    ctx.beginPath();
                    ctx.moveTo(-10, -size - 4);
                    ctx.lineTo(10, -size - 4);
                    ctx.lineTo(0, -size - 14);
                    ctx.fill();
                    ctx.fillStyle = '#5C4033';
                    ctx.fillRect(dir * 8, -size/2, 20, 4);
                    ctx.fillStyle = '#444';
                    ctx.fillRect(dir * 8 + dir * 16, -size/2 - 1, 6, 6);
                    break;

                case '–ö–∞–≤–∞–ª–µ—Ä–∏—è':
                    ctx.fillStyle = '#8B4513';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/3 + 5, size/1.4, size/2.2, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.ellipse(dir * 18, -size/2 + 3, 7, 10, dir * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#6B4423';
                    const legAnim = Math.sin(Date.now() / 100) * 4;
                    ctx.fillRect(-10, -3, 4, 12 + legAnim);
                    ctx.fillRect(6, -3, 4, 12 - legAnim);
                    ctx.fillStyle = '#DAA520';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2 - 10, 7, 10, 0, 0, Math.PI * 2);
                    ctx.fill();
                    drawHead2(0, -size - 5, 5, isEnemy);
                    ctx.strokeStyle = '#C0C0C0';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(dir * 10, -size/2 - 8);
                    ctx.quadraticCurveTo(dir * 22, -size/2, dir * 18, -size/2 + 12);
                    ctx.stroke();
                    break;

                case '–ö–∞–Ω–æ–Ω–∏—Ä':
                    ctx.fillStyle = '#2F4F4F';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2 + 4, size/2, size/2, 0, 0, Math.PI * 2);
                    ctx.fill();
                    drawHead2(0, -size + 5, size/3.5, isEnemy);
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(-6, -size + 2, 12, 4);
                    ctx.fillStyle = '#444';
                    ctx.fillRect(dir * 4, -size/2 + 6, 16, 8);
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.arc(dir * 8, -size/2 + 16, 5, 0, Math.PI * 2);
                    ctx.arc(dir * 16, -size/2 + 16, 5, 0, Math.PI * 2);
                    ctx.fill();
                    break;

                // ===== –°–û–í–†–ï–ú–ï–ù–ù–û–°–¢–¨ =====
                case '–°–æ–ª–¥–∞—Ç':
                    drawBody('#556B2F', size);
                    ctx.fillStyle = '#3d4f22';
                    ctx.beginPath();
                    ctx.arc(-4, -size/2 - 4, 3, 0, Math.PI * 2);
                    ctx.arc(3, -size/2 + 2, 2, 0, Math.PI * 2);
                    ctx.fill();
                    drawHead2(0, -size - 2, size/3.5, isEnemy);
                    ctx.fillStyle = '#556B2F';
                    ctx.beginPath();
                    ctx.arc(0, -size - 2, size/2.5, Math.PI, 0);
                    ctx.fill();
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(dir * 7, -size/2 - 4, 18, 4);
                    ctx.fillRect(dir * 7, -size/2, 3, 8);
                    break;

                case '–¢–∞–Ω–∫':
                    ctx.fillStyle = '#2a2a2a';
                    ctx.fillRect(-size/2, -6, size, 14);
                    ctx.fillStyle = '#3d3d3d';
                    for(let i = 0; i < 4; i++) {
                        ctx.beginPath();
                        ctx.arc(-size/2 + 8 + i * (size-16)/3, 0, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    ctx.fillStyle = '#3D5C3D';
                    ctx.beginPath();
                    ctx.moveTo(-size/2 + 4, -6);
                    ctx.lineTo(size/2 - 4, -6);
                    ctx.lineTo(size/2 - 8, -size/2 + 5);
                    ctx.lineTo(-size/2 + 8, -size/2 + 5);
                    ctx.fill();
                    ctx.fillStyle = '#4a6b4a';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2, size/3.5, size/4.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#2F4F2F';
                    ctx.fillRect(dir * 4, -size/2 - 3, dir * 25, 5);
                    break;

                case '–°–Ω–∞–π–ø–µ—Ä':
                    ctx.fillStyle = '#708090';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2, size/2.2, size/1.8, 0, 0, Math.PI * 2);
                    ctx.fill();
                    drawHead2(0, -size - 2, size/3.5, isEnemy);
                    ctx.fillStyle = '#5a6a5a';
                    ctx.beginPath();
                    ctx.arc(0, -size - 1, size/2.2, Math.PI * 0.7, Math.PI * 0.3);
                    ctx.fill();
                    ctx.fillStyle = '#2a2a2a';
                    ctx.fillRect(dir * 4, -size/2 - 2, 28, 3);
                    break;

                // ===== –ë–£–î–£–©–ï–ï =====
                case '–ö–∏–±–æ—Ä–≥':
                    ctx.fillStyle = '#00CED1';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2, size/2.2, size/1.8, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#4a4a4a';
                    ctx.beginPath();
                    ctx.arc(-5, -size/2, 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillRect(3, -size/2 - 8, 6, 16);
                    ctx.fillStyle = '#FFE4C4';
                    ctx.beginPath();
                    ctx.arc(0, -size - 2, size/3.5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FF0000';
                    ctx.beginPath();
                    ctx.arc(dir * 3, -size - 3, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#333';
                    ctx.fillRect(dir * 8, -size/2 - 2, 16, 5);
                    ctx.fillStyle = '#00FFFF';
                    ctx.fillRect(dir * 22, -size/2 - 1, 4, 3);
                    break;

                case '–ú–µ—Ö':
                    ctx.fillStyle = '#6a5acd';
                    ctx.fillRect(-12, -8, 7, 18);
                    ctx.fillRect(5, -8, 7, 18);
                    ctx.fillStyle = '#9400D3';
                    ctx.beginPath();
                    ctx.moveTo(-size/2, -8);
                    ctx.lineTo(size/2, -8);
                    ctx.lineTo(size/2 - 4, -size/2 - 8);
                    ctx.lineTo(-size/2 + 4, -size/2 - 8);
                    ctx.fill();
                    ctx.fillStyle = '#5a3a7a';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2 - 12, size/3.5, size/4.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'rgba(0,255,255,0.5)';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2 - 12, size/5, size/6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#555';
                    ctx.fillRect(-size/2 + 4, -size/2 - 20, 5, 12);
                    ctx.fillRect(size/2 - 9, -size/2 - 20, 5, 12);
                    break;

                case '–î—Ä–æ–Ω':
                    const hover = Math.sin(Date.now() / 150) * 3;
                    ctx.translate(0, hover - 5);
                    ctx.fillStyle = '#FF4500';
                    ctx.beginPath();
                    ctx.ellipse(0, -size/2 + 5, size/1.8, size/3, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'rgba(150,150,150,0.6)';
                    const propAngle = Date.now() / 25;
                    ctx.beginPath();
                    ctx.ellipse(-10, -size/2 - 3, 8, 2, propAngle, 0, Math.PI * 2);
                    ctx.ellipse(10, -size/2 - 3, 8, 2, -propAngle, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#333';
                    ctx.fillRect(-2, -size/2 + 8, 4, 10);
                    ctx.fillStyle = '#00FF00';
                    ctx.beginPath();
                    ctx.arc(dir * 6, -size/2 + 5, 3, 0, Math.PI * 2);
                    ctx.fill();
                    break;

                default:
                    drawBody(color, size);
                    drawHead2(0, -size - 2, size/3.5, isEnemy);
            }

            ctx.restore();

            // HP –±–∞—Ä
            const hpPercent = Math.max(0, hp / maxHp);
            const barWidth = 28;
            const barY = y - size - size/2 - 5;
            ctx.fillStyle = '#222';
            ctx.fillRect(x - barWidth/2 - 1, barY - 1, barWidth + 2, 7);
            ctx.fillStyle = isEnemy ? '#FF4444' : '#44FF44';
            ctx.fillRect(x - barWidth/2, barY, barWidth * hpPercent, 5);
        }

        function drawBody(color, size) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.ellipse(0, -size/2, size/2.2, size/1.8, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawHead2(hx, hy, r, isEnemy) {
            ctx.fillStyle = '#FFE4C4';
            ctx.beginPath();
            ctx.arc(hx, hy, r, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(hx + (isEnemy ? -2 : 2), hy - 1, 1.5, 0, Math.PI * 2);
            ctx.fill();
        }
    </script>
</body>
</html>
